name: CI/CD Laravel Build

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  IMAGE_NAME: laravel_sample_app
  PHP_VERSION: "8.4"

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # PHP setup
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo_sqlite, zip, intl
          coverage: none

      - name: Copy .env file
        run: |
          cp .env.testing .env

      - name: Install Composer dependencies
        run: composer install -q --prefer-dist --no-ansi --no-interaction --no-scripts --no-progress

      - name: Directory permissions
        run: |
          sudo chown -R $USER:$USER storage bootstrap/cache
          chmod -R 775 storage bootstrap/cache

      - name: Run tests
        run: |
          php artisan test

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install NPM dependencies
        run: npm install

      - name: Build frontend assets
        run: npm run build

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: public/build

  docker-build:
    needs: [build-and-test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: public/build

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push PHP-FPM image
        uses: docker/build-push-action@v6
        with:
          context: .
          target: php-fpm
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:php-fpm-${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:php-fpm-latest

      - name: Build and push Nginx image
        uses: docker/build-push-action@v6
        with:
          context: .
          target: nginx
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:nginx-${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:nginx-latest
